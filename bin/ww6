#!/usr/bin/env perl6
#
# The script to manage ww6 sites.
#

use File::Mkdir;
use File::Find;

## Returns true if the OS is not Windows.
sub not_win {
  $*VM<config><osname> ne 'MSWin32';
}

## chmod, is completely ignored on Windows.
sub chmod($file, $mode) {
  if not_win() {
    run "chmod $mode $file";
  }
}

sub show-types {
  say "Invalid create type specified. Valid types:";
  ## TODO: make this read the templates folder and list the found templates.
  say "  cms           An active content management system";
  exit;
}

## Create a new site, by default creates it in the current folder.
## The current hackish place for the resource directory is in ~/.perl6/share
## It finds it by looking where 'ww6' is (generally ~/.perl6/bin) and setting
## the resdir to ../share/webtoo from that path.

multi sub MAIN (:$create!, :$dir='.') {
  my $resdir = $*PROGRAM_NAME.subst('ww6', '../share/webtoo');
  my $tdir = $resdir~'/templates/'~$create;
  if $tdir.IO ~~ :d {
    print "Creating a new '$create' in '$dir'... ";
    for find(dir => $tdir, type => 'file').list -> $file {
      my $target-dir = $file.dir.subst($tdir, $dir);
      mkdir $target-dir, :p;
      if not_win() {
        run "cp $file $target-dir/{$file.name}";
      }
      else {
        run "copy $file $target-dir/{$file.name}";
      }
    }
    say "done.";
  }
  else {
    show-types;
  }
}

